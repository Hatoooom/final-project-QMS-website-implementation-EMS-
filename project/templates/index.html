<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EMS C2 | ISO 22320 QMS</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* --- THEME & VARIABLES --- */
        :root {
            --bg-dark: #0f172a;
            --bg-panel: #1e293b;
            --accent: #3b82f6;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --border: #334155;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-primary);
            margin: 0;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* --- SIDEBAR --- */
        .sidebar {
            width: 260px;
            background: var(--bg-panel);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            padding: 10px;
            z-index: 20;
        }

        .nav-btn {
            background: transparent;
            color: var(--text-secondary);
            border: none;
            padding: 15px;
            text-align: left;
            cursor: pointer;
            border-radius: 6px;
            margin-bottom: 5px;
            width: 100%;
            transition: 0.2s;
        }

        .nav-btn:hover {
            background: rgba(255, 255, 255, 0.05);
            color: white;
        }

        .nav-btn.active {
            background: var(--accent);
            color: white;
            font-weight: bold;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
        }

        /* --- MAIN AREA --- */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .view-section {
            display: none;
            flex: 1;
            flex-direction: column;
            padding: 30px;
            animation: fadeIn 0.3s ease;
            overflow-y: auto;
        }

        .view-section.active-view {
            display: flex;
        }

        #view-dashboard {
            padding: 0;
            overflow: hidden;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* --- QMS REPORT STYLES --- */
        .qms-container {
            max-width: 900px;
            margin: 0 auto;
            padding-bottom: 50px;
        }

        .qms-section {
            margin-bottom: 40px;
            border-bottom: 1px solid var(--border);
            padding-bottom: 20px;
        }

        .qms-section h2 {
            color: var(--accent);
            margin-top: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .qms-section h3 {
            color: var(--text-primary);
            margin-top: 25px;
            border-left: 3px solid var(--accent);
            padding-left: 10px;
        }

        .qms-text {
            line-height: 1.7;
            color: var(--text-secondary);
            text-align: justify;
            margin-bottom: 15px;
        }

        .qms-highlight {
            background: rgba(59, 130, 246, 0.05);
            border: 1px solid var(--border);
            padding: 20px;
            margin: 20px 0;
            border-radius: 6px;
        }

        .code-block {
            background: #0f172a;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Consolas', monospace;
            color: #a5b4fc;
            font-size: 13px;
            border: 1px solid var(--border);
            white-space: pre-wrap;
        }

        /* --- CARDS & UI --- */
        .card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
        }

        .card {
            background: var(--bg-panel);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 20px;
        }

        .tag-pass {
            color: var(--success);
            border: 1px solid var(--success);
            padding: 2px 6px;
            font-size: 10px;
            border-radius: 4px;
            background: rgba(16, 185, 129, 0.1);
        }

        .tag-fail {
            color: var(--danger);
            border: 1px solid var(--danger);
            padding: 2px 6px;
            font-size: 10px;
            border-radius: 4px;
            background: rgba(239, 68, 68, 0.1);
        }

        /* --- PROGRESS BARS --- */
        .bar-container {
            background: #334155;
            height: 8px;
            border-radius: 4px;
            margin: 8px 0;
            overflow: hidden;
        }

        .bar-fill {
            height: 100%;
            transition: width 0.5s ease;
        }

        .bg-success {
            background-color: var(--success);
        }

        .bg-danger {
            background-color: var(--danger);
        }

        /* --- MAINTENANCE BUTTONS --- */
        .maint-btn {
            background: #0f172a;
            color: var(--text-secondary);
            flex: 1;
            text-align: center;
            padding: 10px;
            font-size: 12px;
            border: 1px solid var(--border);
            border-radius: 4px;
            cursor: pointer;
            transition: 0.3s;
        }

        .maint-btn:hover {
            background: #333;
            color: white;
        }

        .btn-critical {
            background: var(--danger) !important;
            color: white !important;
            border: 1px solid var(--danger) !important;
            animation: pulse-btn 1s infinite;
            font-weight: bold;
        }

        .btn-warning {
            background: var(--warning) !important;
            color: black !important;
            border: 1px solid var(--warning) !important;
            animation: pulse-btn 1s infinite;
            font-weight: bold;
        }

        @keyframes pulse-btn {
            0% {
                opacity: 1;
                transform: scale(1);
            }

            50% {
                opacity: 0.8;
                transform: scale(0.98);
            }

            100% {
                opacity: 1;
                transform: scale(1);
            }
        }

        /* --- MAP & LOGS --- */
        #map-container {
            flex: 1;
            background-color: #0f172a;
            background-image: linear-gradient(#1e293b 1px, transparent 1px), linear-gradient(90deg, #1e293b 1px, transparent 1px);
            background-size: 40px 40px;
            position: relative;
            overflow: hidden;
        }

        .map-marker {
            position: absolute;
            transform: translate(-50%, -50%);
            display: flex;
            flex-direction: column;
            align-items: center;
            z-index: 10;
            pointer-events: none;
        }

        .ambulance-icon {
            font-size: 20px;
            padding: 8px;
            border-radius: 50%;
            border: 2px solid var(--success);
            background: rgba(16, 185, 129, 0.2);
            color: var(--success);
            box-shadow: 0 0 15px rgba(16, 185, 129, 0.4);
        }

        .ambulance-icon.busy {
            color: var(--warning);
            border-color: var(--warning);
            background: rgba(245, 158, 11, 0.2);
        }

        .incident-icon {
            font-size: 24px;
            color: var(--danger);
            animation: pulse 1s infinite;
            z-index: 1;
        }

        @keyframes pulse {
            0% {
                opacity: 1;
                transform: scale(1);
            }

            50% {
                opacity: 0.5;
                transform: scale(1.2);
            }

            100% {
                opacity: 1;
                transform: scale(1);
            }
        }

        .log-panel {
            height: 200px;
            background: var(--bg-panel);
            border-top: 1px solid var(--border);
            overflow-y: auto;
            padding: 0 20px;
            font-family: monospace;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        th,
        td {
            text-align: left;
            padding: 12px;
            border-bottom: 1px solid var(--border);
        }

        th {
            color: var(--text-secondary);
            background: rgba(0, 0, 0, 0.2);
            position: sticky;
            top: 0;
        }

        /* --- TOAST --- */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--bg-panel);
            border-left: 4px solid var(--accent);
            padding: 15px;
            border-radius: 4px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
            transform: translateX(200%);
            transition: 0.3s;
            z-index: 100;
        }

        .toast.show {
            transform: translateX(0);
        }
    </style>
</head>

<body>

    <div class="sidebar">
        <h2 style="color: var(--accent); margin-bottom: 30px;"><i class="fa-solid fa-shield-halved"></i> EMS <span
                style="font-weight:lighter;">ISO-CMD</span></h2>
        <button class="nav-btn active" onclick="switchView('dashboard')"><i class="fa-solid fa-map-location-dot"></i>
            Command Map</button>
        <button class="nav-btn" onclick="switchView('inventory')"><i class="fa-solid fa-boxes-stacked"></i>
            Inventory</button>
        <button class="nav-btn" onclick="switchView('fleet')"><i class="fa-solid fa-clipboard-check"></i> Fleet
            Status</button>
        <button class="nav-btn" onclick="switchView('stats')"><i class="fa-solid fa-chart-pie"></i> Analytics</button>
        <div style="flex:1"></div>
        <button class="nav-btn" onclick="switchView('qms')"
            style="border-top:1px solid var(--border); color: var(--accent);"><i class="fa-solid fa-book-medical"></i>
            QMS Report</button>
    </div>

    <div class="main-content">

        <div id="view-dashboard" class="view-section active-view">
            <div
                style="height: 60px; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; background: var(--bg-panel); border-bottom: 1px solid var(--border);">
                <div><strong>Compliant Units (ISO):</strong> <span id="dash-active-units"
                        style="color:var(--accent); font-weight:bold;">Loading...</span></div>
                <button onclick="createIncident()"
                    style="background: var(--danger); color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-weight:bold; font-size:14px; box-shadow: 0 4px 10px rgba(239, 68, 68, 0.3);">
                    <i class="fa-solid fa-bell"></i> TRIGGER EMERGENCY
                </button>
            </div>
            <div id="map-container">
                <div class="map-marker" style="top:50%; left:50%; z-index:5;">
                    <div
                        style="background:var(--accent); padding:8px 12px; border-radius:4px; font-weight:bold; font-size:12px; box-shadow:0 0 20px rgba(59, 130, 246, 0.5); color:white;">
                        <i class="fa-solid fa-hospital"></i> HQ</div>
                </div>
                <div id="simulation-layer"></div>
            </div>
            <div class="log-panel">
                <table id="logTable">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Call (T0)</th>
                            <th>Dispatch (T1)</th>
                            <th>Arrival (T2)</th>
                            <th>Return (T3)</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <div id="view-inventory" class="view-section">
            <h1><i class="fa-solid fa-boxes-stacked"></i> Hospital Inventory</h1>
            <div class="card-grid">
                <div class="card">
                    <h3>Current Stock</h3>
                    <table id="inventory-table">
                        <thead>
                            <tr>
                                <th>Item</th>
                                <th>Qty</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
                <div class="card">
                    <h3><i class="fa-solid fa-dolly"></i> Restock</h3>
                    <select id="inv-select"
                        style="padding:10px; width:100%; margin-bottom:10px; background:#000; color:white; border:1px solid var(--border);">
                        <option value="bandages">Bandages</option>
                        <option value="oxygen">Oxygen</option>
                    </select>
                    <input type="number" id="inv-qty"
                        style="padding:10px; width:100%; margin-bottom:10px; background:#000; color:white; border:1px solid var(--border);"
                        value="10">
                    <button onclick="addInventory()"
                        style="width:100%; padding:10px; background:var(--success); border:none; color:white; font-weight:bold; cursor:pointer;">CONFIRM
                        DELIVERY</button>
                </div>
            </div>
        </div>

        <div id="view-fleet" class="view-section">
            <h1><i class="fa-solid fa-clipboard-check"></i> Fleet Readiness</h1>
            <p style="color:var(--text-secondary);">Units below 30% Fuel or 50% Health are grounded per ISO safety
                protocols.</p>
            <div id="fleet-grid" class="card-grid"></div>
        </div>

        <div id="view-stats" class="view-section">
            <h1><i class="fa-solid fa-chart-line"></i> Analytics</h1>
            <div class="card-grid">
                <div class="card">
                    <h3>Incident Volume</h3><canvas id="chart-response"></canvas>
                </div>
                <div class="card">
                    <h3>Fleet Availability</h3><canvas id="chart-load"></canvas>
                </div>
            </div>
        </div>

        <div id="view-qms" class="view-section">
            <div class="qms-container">
                <h1 style="border-bottom: 2px solid var(--accent); padding-bottom:10px;">Quality Management System (QMS)
                    Report</h1>
                <p style="color:var(--text-secondary); margin-bottom:30px;">This report outlines the adherence of the
                    EMS Command System to <strong>ISO 22320:2011</strong> standards for Emergency Management,
                    highlighting key processes, challenges faced, and technical resolutions.</p>

                <div class="qms-section">
                    <h2><i class="fa-solid fa-certificate"></i> 1. Applied QMS Standards (ISO 22320)</h2>
                    <p class="qms-text">The system architecture is strictly governed by the three pillars of the ISO
                        22320 standard for societal security and emergency management:</p>

                    <h3>A. Command and Control (C2)</h3>
                    <p class="qms-text">
                        The <strong>"Command Map"</strong> provides a centralized operational picture. It allows the
                        Incident Commander to visualize all assets in real-time, ensuring that decision-making is based
                        on a single source of truth. The system enforces a clear hierarchy where only the Command Center
                        can trigger incidents.
                    </p>

                    <h3>B. Operational Information Management</h3>
                    <p class="qms-text">
                        To ensure auditability and accountability, the system utilizes precise timestamp logging for
                        every phase of an emergency lifecycle:
                        <br><code>T0 (Call)</code> -> <code>T1 (Dispatch)</code> -> <code>T2 (Arrival)</code> ->
                        <code>T3 (Return)</code>.
                        <br>This data is immutable and stored in the database for post-incident analysis.
                    </p>

                    <h3>C. Cooperation and Coordination</h3>
                    <p class="qms-text">
                        The <strong>"Inventory"</strong> and <strong>"Fleet"</strong> modules facilitate coordination
                        between logistics and operations. By tracking consumable resources (Oxygen, Bandages) alongside
                        vehicle health, the system prevents silos where operations might dispatch units that logistics
                        has not yet serviced.
                    </p>
                </div>

                <div class="qms-section">
                    <h2><i class="fa-solid fa-triangle-exclamation"></i> 2. Challenge Identification</h2>
                    <p class="qms-text">During the stress-testing phase of the QMS implementation, a critical
                        <strong>Non-Conformity (NC)</strong> was identified regarding <strong>Operational Continuity vs.
                            Asset Degradation</strong>.</p>

                    <div class="qms-highlight">
                        <strong>The Conflict:</strong>
                        <br>
                        In a high-intensity emergency scenario, operators were prioritizing "Response Speed" over "Asset
                        Safety." Ambulances were being dispatched repeatedly without maintenance. This led to a
                        theoretical failure state where units with <span style="color:var(--danger)">0% Health</span> or
                        <span style="color:var(--danger)">0% Fuel</span> were still being assigned to critical missions,
                        violating ISO safety protocols.
                    </div>
                </div>

                <div class="qms-section">
                    <h2><i class="fa-solid fa-check-double"></i> 3. Resolution & Implementation</h2>
                    <p class="qms-text">To resolve this non-conformity, we engineered a <strong>Automated Compliance
                            Logic Gate</strong> directly into the dispatch algorithm.</p>

                    <h3>A. The Solution</h3>
                    <p class="qms-text">
                        We removed the human error factor by automating the decision to "ground" a vehicle. The system
                        now performs a mandatory pre-flight check before every dispatch attempt. If a unit falls below
                        defined thresholds (Fuel < 30% or Health < 50%), it is mathematically impossible to dispatch it.
                            </p>

                            <h3>B. Technical Demonstration</h3>
                            <p class="qms-text">The following logic is executed on the client-side before any API call
                                is made:</p>

                            <div class="code-block">
                                // CODE SNIPPET: The Compliance Gate
                                function checkCompliance(amb) {
                                let reasons = [];

                                // ISO Standard Thresholds
                                if (amb.fuel < 30) reasons.push("Fuel Critical"); if (amb.health < 50)
                                    reasons.push("Hull Integrity Fail"); if (!amb.supplies_ok) reasons.push("Inventory
                                    Depleted"); // If any reason exists, unit is rejected return { isCompliant:
                                    reasons.length===0, reasons: reasons }; } </div>

                                    <h3>C. Visual Feedback Loop</h3>
                                    <p class="qms-text">
                                        To further aid the operator, the resolution includes a visual feedback
                                        mechanism. When a unit is grounded:
                                        <br>1. The status badge turns to <span class="tag-fail">UNFIT</span>.
                                        <br>2. The specific "Repair" or "Refuel" button begins to <strong>Pulse
                                            Red</strong>, guiding the user to the exact corrective action required to
                                        restore compliance.
                                    </p>
                            </div>

                            <div
                                style="text-align:center; padding: 20px; color: var(--text-secondary); font-size: 12px; margin-top:50px;">
                                Generated by EMS-C2 System | ISO Compliance Module | Version 1.0.4
                            </div>
                </div>
            </div>

        </div>

        <div id="toast" class="toast">
            <h4 style="margin:0;">Alert</h4>
            <p id="toast-msg" style="margin:5px 0 0 0;">Msg</p>
        </div>

        <script>
            // --- CONSTANTS ---
            const STANDARDS = { fuelMin: 30, healthMin: 50 };
            const SPEED_FACTOR = 80;

            let state = { ambulances: [], inventory: {}, logs: [] };
            let charts = {};
            let isPolling = false;

            function init() {
                initCharts();
                fetchData();
                setInterval(() => { if (!isPolling) fetchData(); }, 2000);
                ['AMB-01', 'AMB-02', 'AMB-03'].forEach(id => { if (!document.getElementById('marker-' + id)) createMarker(id); });
            }

            async function fetchData() {
                isPolling = true;
                try {
                    const res = await fetch('/api/state');
                    const data = await res.json();
                    state.ambulances = data.ambulances;
                    state.inventory = data.inventory;
                    state.logs = data.logs;
                    renderFleet(); renderInventory(); renderLogs(); updateCharts(); updateActiveCount();
                    state.ambulances.forEach(amb => { if (!document.getElementById('marker-' + amb.id)) createMarker(amb.id); });
                } catch (e) { console.error(e); }
                isPolling = false;
            }

            async function createIncident() {
                const compliantUnits = state.ambulances.filter(a => checkCompliance(a).isCompliant && a.status === 'IDLE');
                if (compliantUnits.length === 0) { showToast("CRITICAL: NO COMPLIANT UNITS!", "danger"); return; }

                const unit = compliantUnits[0];
                const incId = 'INC-' + Math.floor(Math.random() * 10000);
                const x = Math.random() * 80 + 10;
                const y = Math.random() * 80 + 10;

                showToast(`Incoming Call: ${incId}`, 'warning');
                await fetch('/api/incident', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ action: 'create', id: incId }) });
                fetchData();

                setTimeout(async () => {
                    showToast(`${unit.id} Dispatched`, 'success');
                    createIncMarker(incId, x, y);
                    await fetch('/api/incident', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ action: 'dispatch', id: incId, unit_id: unit.id }) });
                    runSimulationSequence(unit.id, incId, x, y);
                }, 2000);
            }

            function runSimulationSequence(unitId, incId, targetX, targetY) {
                const el = document.getElementById('marker-' + unitId);
                const icon = el.querySelector('.ambulance-icon');
                const dist = Math.sqrt(Math.pow(targetX - 50, 2) + Math.pow(targetY - 50, 2));
                const travelTime = Math.round(dist * SPEED_FACTOR);

                el.style.transition = `top ${travelTime}ms ease-in-out, left ${travelTime}ms ease-in-out`;
                icon.classList.add('busy');
                el.style.left = targetX + '%'; el.style.top = targetY + '%';

                setTimeout(async () => {
                    fetch('/api/incident', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ action: 'arrive', id: incId, unit_id: unitId }) });
                    setTimeout(async () => {
                        if (document.getElementById('inc-' + incId)) document.getElementById('inc-' + incId).remove();
                        el.style.left = '50%'; el.style.top = '50%';
                        setTimeout(async () => {
                            icon.classList.remove('busy');
                            await fetch('/api/incident', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ action: 'close', id: incId, unit_id: unitId }) });
                            showToast(`${unitId} Mission Complete`, 'success');
                            fetchData();
                        }, travelTime);
                    }, 1500);
                }, travelTime);
            }

            async function performAction(id, type) {
                showToast(`${type} ${id}...`, 'success');
                await fetch('/api/maintenance', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ id: id, type: type }) });
                fetchData();
            }
            async function addInventory() {
                await fetch('/api/inventory/add', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ item_key: document.getElementById('inv-select').value, qty: parseInt(document.getElementById('inv-qty').value) }) });
                showToast("Inventory Added", "success"); fetchData();
            }

            function checkCompliance(amb) {
                let reasons = [];
                if (amb.fuel < STANDARDS.fuelMin) reasons.push("Fuel Low");
                if (amb.health < STANDARDS.healthMin) reasons.push("Needs Repair");
                if (!amb.supplies_ok) reasons.push("No Supplies");
                return { isCompliant: reasons.length === 0, reasons: reasons };
            }

            function renderFleet() {
                const grid = document.getElementById('fleet-grid'); grid.innerHTML = '';
                state.ambulances.forEach(amb => {
                    const comp = checkCompliance(amb);
                    const needRepair = amb.health < STANDARDS.healthMin;
                    const needFuel = amb.fuel < STANDARDS.fuelMin;
                    const needStock = !amb.supplies_ok;

                    grid.innerHTML += `
                <div class="card">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <h3 style="margin:0; border:none;">${amb.id}</h3>
                        ${comp.isCompliant ? '<span class="tag-pass">READY</span>' : '<span class="tag-fail">UNFIT</span>'}
                    </div>
                    <hr style="border-color:var(--border); margin:10px 0;">
                    <div style="font-size:12px;">
                        <div style="display:flex; justify-content:space-between;"><span>Fuel</span>${needFuel ? '<span style="color:var(--danger)">CRITICAL</span>' : ''}</div>
                        <div class="bar-container"><div class="bar-fill ${needFuel ? 'bg-danger' : 'bg-success'}" style="width:${amb.fuel}%"></div></div>
                        <div style="display:flex; justify-content:space-between;"><span>Health</span>${needRepair ? '<span style="color:var(--danger)">DAMAGED</span>' : ''}</div>
                        <div class="bar-container"><div class="bar-fill ${needRepair ? 'bg-danger' : 'bg-success'}" style="width:${amb.health}%"></div></div>
                    </div>
                    <div style="display:flex; gap:5px; margin-top:15px;">
                        <button class="maint-btn ${needFuel ? 'btn-critical' : ''}" onclick="performAction('${amb.id}', 'refuel')">Refuel</button>
                        <button class="maint-btn ${needRepair ? 'btn-critical' : ''}" onclick="performAction('${amb.id}', 'repair')">Repair</button>
                        <button class="maint-btn ${needStock ? 'btn-warning' : ''}" onclick="performAction('${amb.id}', 'restock')">Stock</button>
                    </div>
                </div>`;
                });
            }
            function renderInventory() {
                const tb = document.getElementById('inventory-table').querySelector('tbody'); tb.innerHTML = '';
                Object.values(state.inventory).forEach(i => tb.innerHTML += `<tr><td>${i.name}</td><td>${i.qty}</td><td>${i.qty >= i.min_qty ? '<span class="tag-pass">OK</span>' : '<span class="tag-fail">LOW</span>'}</td></tr>`);
            }
            function renderLogs() {
                const tb = document.getElementById('logTable').querySelector('tbody'); tb.innerHTML = '';
                const fmt = (t) => t ? new Date(t).toLocaleTimeString() : '-';
                state.logs.forEach(l => tb.innerHTML += `<tr><td>${l.id}</td><td>${fmt(l.t0)}</td><td>${fmt(l.t1)}</td><td>${fmt(l.t2)}</td><td>${fmt(l.t3)}</td><td>${l.status}</td></tr>`);
            }
            function updateCharts() {
                if (!charts.response) return;
                charts.response.data.datasets[0].data = [state.logs.length, state.logs.filter(l => l.status === 'CLOSED').length]; charts.response.update();
                const c = state.ambulances.filter(a => checkCompliance(a).isCompliant).length;
                charts.load.data.datasets[0].data = [c, state.ambulances.length - c]; charts.load.update();
            }
            function initCharts() {
                charts.response = new Chart(document.getElementById('chart-response'), { type: 'bar', data: { labels: ['Total', 'Closed'], datasets: [{ label: 'Vol', data: [0, 0], backgroundColor: '#3b82f6' }] }, options: { plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } } });
                charts.load = new Chart(document.getElementById('chart-load'), { type: 'doughnut', data: { labels: ['Ready', 'Not Ready'], datasets: [{ data: [1, 1], backgroundColor: ['#10b981', '#ef4444'] }] } });
            }
            function updateActiveCount() {
                const c = state.ambulances.filter(a => checkCompliance(a).isCompliant).length;
                document.getElementById('dash-active-units').innerText = c + " / " + state.ambulances.length;
            }
            function switchView(v) {
                document.querySelectorAll('.view-section').forEach(e => e.classList.remove('active-view'));
                document.getElementById('view-' + v).classList.add('active-view');
                document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active')); event.currentTarget.classList.add('active');
            }
            function showToast(m, t) {
                const el = document.getElementById('toast'); document.getElementById('toast-msg').innerText = m;
                el.style.borderLeftColor = t === 'danger' ? 'var(--danger)' : 'var(--success)';
                el.classList.add('show'); setTimeout(() => el.classList.remove('show'), 3000);
            }
            function createMarker(id) {
                const el = document.createElement('div'); el.id = 'marker-' + id; el.className = 'map-marker';
                el.style.top = '50%'; el.style.left = '50%';
                el.innerHTML = `<i class="fa-solid fa-truck-medical ambulance-icon"></i><span style="font-size:10px; background:#000; padding:2px; color:white;">${id}</span>`;
                document.getElementById('simulation-layer').appendChild(el);
            }
            function createIncMarker(id, x, y) {
                const el = document.createElement('div'); el.id = 'inc-' + id; el.className = 'map-marker incident-icon';
                el.innerHTML = '<i class="fa-solid fa-fire-burner"></i>'; el.style.left = x + '%'; el.style.top = y + '%';
                document.getElementById('simulation-layer').appendChild(el);
            }
            init();
        </script>
</body>

</html>